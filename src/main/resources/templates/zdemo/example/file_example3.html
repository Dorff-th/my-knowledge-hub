<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <title>file example 3 드래그 앤 드롭</title>
    <style>
        #dropZone {
          border: 2px dashed #888;
          border-radius: 8px;
          padding: 20px;
          text-align: center;
          color: #555;
          cursor: pointer;
          margin-bottom: 10px;
        }
        #dropZone.dragover {
          background-color: #eef;
          border-color: #36f;
          color: #36f;
        }
        #fileList li {
          margin: 5px 0;
        }
    </style>
</head>
<body>
<div id="dropZone">여기로 파일을 드래그하거나 클릭하세요</div>

<form action="/zdemo/file-example2" method="post" enctype="multipart/form-data">
    <input type="file" name="attachments" id="fileInput" multiple > <br/>
    <button>전송</button>
</form>
<ul id="fileList"></ul>
<p id="totalSizeInfo"></p>

<script>
    const dropZone = document.querySelector('#dropZone');
    const input    = document.querySelector('#fileInput');
    const list     = document.querySelector('#fileList');
    const info     = document.querySelector('#totalSizeInfo');

    let selectedFiles = [];     // 파일을 선택하면 이 배열에 저장

    //파일이나 링크들을 해당 div 영역에 마우스로 드래그 할때 이벤트 발생 (마우스 우클릭 버튼 꾹 그리고 이 div 영역으로 이동)
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
        console.log('드래그 오버');
    });

    // 파일이나 링크들을 해당 div 영역에서 벗어날때(마우스 우클릭 꾹 이영역으로 이동했다가 벗어날때 발생)
    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
        console.log('드래그 리브');
    });

    //파일이나 링크들을 해당 div 영역에 마우스로 드래그 (마우스 드래그 이후 우클릭 버튼 손가락 뗌)
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');

        console.log('드랍');
        handleFiles(e.dataTransfer.files);
    });

    function handleFiles(files) {
        console.log(files);
        const fileList = document.querySelector("#fileList");
        for(file of files) {

            const li = document.createElement('li');
            li.textContent = `파일명 : ${file.name}, 파일크기 : ${formatFileSize(file.size)}, 파일타입 : ${file.type}`;
            fileList.appendChild(li);
        }
    }

    dropZone.addEventListener('click', () => input.click());

    input.addEventListener('change', () => {
      handleFiles(input.files);
    });


    function formatFileSize(bytes) {

        if (bytes < 1024) {
            return bytes + " B";
        } else if (bytes < 1024 * 1024) {
            return (bytes / 1024).toFixed(2) + " KB";
        } else {
            return (bytes / (1024 * 1024)).toFixed(2) + " MB";
        }
    }

    document.querySelector("#fileInput").addEventListener("change", (e) => {
            const files = e.target.files;
            selectedFiles = selectedFiles.concat([...files]);
            drawFileList();     // 화면에 표시될 파일 목록 갱신
            updateInputFiles(document.querySelector("#fileInput"), selectedFiles);
    });

    function drawFileList() {
        const fileList = document.querySelector("#fileList");
        fileList.innerHTML = ""; // 기존 목록 초기화

        selectedFiles.forEach((file, index) => {

            const li = document.createElement('li');

            const fileInfo = document.createElement('span');
            fileInfo.textContent = `파일명 : ${file.name}, 파일크기 : ${formatFileSize(file.size)}` ;

            const btn = document.createElement('button');
            btn.type = 'button';
            btn.textContent = '삭제';
            btn.addEventListener('click', () => {
                removeFileInfo(index, document.querySelector("#fileInput"), selectedFiles);
            });

            li.appendChild(fileInfo);
            li.appendChild(btn);

            fileList.appendChild(li);


        });

    }

    function removeFileInfo(index,  inputEl, files) {
        // 배열에서 제거
        selectedFiles.splice(index, 1);
        //file input  갱신
        updateInputFiles(inputEl, files);
        // 화면 다시 그림
        drawFileList();
    }

    //file input  재구성
    function updateInputFiles(inputEl, files) {
        const dt = new DataTransfer();
        files.forEach(file => dt.items.add(file));
        inputEl.files = dt.files;
    }
</script>
</body>
</html>