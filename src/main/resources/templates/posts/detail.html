<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{${#authorization.expression('isAuthenticated()')} ?
                          'layouts/layout-main' :
                          'layouts/layout-public'}">
<body>
<main layout:fragment="body" id="post-detail"  th:data-post-id="${post.id}">

    <div class="max-w-3xl mx-auto space-y-4 my-8 mt-10">
        <!-- ğŸ”– ì œëª© ì¹´ë“œ -->
        <div class="bg-white shadow-md rounded-lg p-6">
            <span class="inline-block text-sm font-medium text-blue-600 mb-2" th:text="${post.categoryName}">Development</span>
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800"
                th:text="${post.title}">Understanding Dependency Injection</h1>
            <p class="text-sm text-gray-500 mt-2"
               th:text="${post.nickname} + ' Â· ' + ${#temporals.format(post.createdAt, 'MMM dd, yyyy')}">
                By John Doe Â· Apr 24, 2024
            </p>
            <p class="text-sm text-gray-500 mt-2" th:if="${post.updatedAt != null}">
                last update :  <span th:text="${#temporals.format(post.updatedAt, 'yyyy-MM-dd HH:mm:ss')}"> </span>
            </p>
        </div>

        <!-- ğŸ“Œ ë³¸ë¬¸ ì½˜í…ì¸  ì¹´ë“œ -->
        <div class="bg-white shadow-md rounded-lg p-6">
            <div class="prose prose-lg prose-gray max-w-none">
                <div id="viewer"></div>
                <!--<p th:text="${post.content}">
                    Dependency injection (DI) is a design pattern to assist pattern provisioning lead in script benefits.
                </p>-->
            </div>

            <!-- ì‚­ì œ ë²„íŠ¼ -->
            <div class="mt-6" th:if="${loginUserId != null and post.memberId == loginUserId}">
                <form th:action="@{/posts/{id}/delete(id=${post.id})}" method="post" class="inline-form">
                    <button type="submit" title="ì‚­ì œ" class="inline-block bg-gray-100 hover:bg-gray-200 text-gray-700 py-1 px-4 rounded-full text-sm transition duration-150"
                            onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">âŒì‚­ì œí•˜ê¸°</button>
                </form>
            </div>

            <div class="mt-6" th:if="${loginUserId != null and post.memberId == loginUserId}">
                <a th:href="@{/posts/{id}/edit(id=${post.id})}"
                   class="inline-block bg-gray-100 hover:bg-gray-200 text-gray-700 py-1 px-4 rounded-full text-sm transition duration-150">
                    ìˆ˜ì •í•˜ê¸°
                </a>
            </div>

            <div class="mt-6">
                <a href="/posts"
                   class="inline-block bg-gray-100 hover:bg-gray-200 text-gray-700 py-1 px-4 rounded-full text-sm transition duration-150">
                    â† ëª©ë¡ìœ¼ë¡œ
                </a>
            </div>
        </div>

        <!-- ğŸ’¬ ëŒ“ê¸€ ì˜ì—­ ì¹´ë“œ -->
        <div class="bg-white shadow-md rounded-lg p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ’¬ ëŒ“ê¸€</h3>

            <!-- ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ -->
            <div id="comment-container" class="space-y-4">
                <!-- ë™ì  ëŒ“ê¸€ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>

            <!-- ëŒ“ê¸€ ì…ë ¥ í¼ -->
            <form class="mt-6 space-y-4">
      <textarea class="w-full border border-gray-300 rounded-md p-2 shadow-sm resize-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." required></textarea>
                <button type="submit"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md transition duration-200">
                    ëŒ“ê¸€ ì‘ì„±
                </button>
            </form>
        </div>

    </div>

</main>
<div layout:fragment="page-script">
    <script type="module" th:inline="javascript">
        import { showLoading, hideLoading } from /*[[@{/js/loading.js}]]*/ '';
        import { showInfoToast } from /*[[@{/js/toast.js}]]*/ '';

        const postId = document.getElementById("post-detail").dataset.postId;

        async function fetchData() {
            showLoading();
            try {
                fetch(`/api/posts/${postId}/comments`)
                    .then(res => res.json())
                    .then(comments => {
                        const container = document.getElementById("comment-container");
                        container.innerHTML = comments.map(c => `
                        <div class="comment-box">
                        <p><strong>${c.username}</strong> Â· ${c.createdAt}</p>
                        <p>${c.content}</p>
                        </div>
                    `).join('');
                });
            } finally {
                hideLoading();
            }
        }
        fetchData();

        const content = /*[[${post.content}]]*/ ""; // ë§ˆí¬ë‹¤ìš´ í…ìŠ¤íŠ¸
        const viewer = new toastui.Editor.factory({
            el: document.querySelector('#viewer'),
            viewer: true,
            initialValue: content
        });

        //ê¸€ì“°ê¸° ì €ì¥ì´ ì™„ë£Œë˜ê³  ë‚œë’¤ì—  ì €ì¥ì„±ê³µ toastë©”ì‹œì§€ ë„ìš°ê¸°, localStorage tempKey ì‚­ì œ
        const params = new URLSearchParams(window.location.search);
        if (params.get("fromSave") === "true" && params.get("saveType") === "created") {
            showInfoToast("Post ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            localStorage.removeItem("tempPostKey");
        } else if (params.get("fromSave") === "true" && params.get("saveType") === "updated") {
            showInfoToast("Post ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            localStorage.removeItem("tempPostKey");
        }
    </script>
</div>
</body>
</html>
